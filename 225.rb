# 終値一覧

require 'open-uri'
require 'csv'

base_url = "https://www.google.com/finance/getprices"
code_array = [7013,8304,3407,5201,2502,2802,4503,6857,6113,6770,8267,7202,8001,4208,4523,9202,6472,9613,9437,6361,8725,6103,9532,3861,4578,1802,6703,9007,7733,4452,6952,1812,9107,7012,9503,2801,7751,6971,4151,2503,6326,3405,8253,9008,9009,9433,5406,1605,9766,4902,6301,1721,7186,2501,3436,6674,5411,5020,6473,3086,4507,8355,4911,7762,1803,9104,5002,4004,4063,8303,5401,9412,7735,7269,7270,5232,4005,5713,6302,8053,5802,8830,1928,9735,3382,2768,6758,8729,9984,8630,4568,8750,6367,1801,7912,4506,5541,5233,6976,1925,8601,8233,2531,4502,8331,4519,9502,6366,8795,2432,3401,6762,4543,4061,6902,4324,5301,9022,3289,8035,8766,9531,9005,8804,9501,9681,6502,4042,5332,9001,9602,5707,5901,3101,3402,5714,4043,7911,7203,8015,4704,7731,9021,2871,1963,4021,7201,5413,2002,3105,6988,5202,5333,4272,5703,1332,6471,3863,5631,4041,2914,9062,6701,5214,9432,2282,9101,8604,6773,1808,6752,9020,6305,6501,7004,7205,9983,6954,8354,5803,6702,6504,4901,5108,5715,5801,3865,7267,8628,7261,8252,1333,8002,8411,4183,5706,8309,8316,7003,8031,8801,3099,4188,7211,7011,8058,9301,8802,6503,5711,8306,6479,2269,6508,6506,4689,9064,7951,7272,8028,3103,6841,5101,7752,8308]
interval = 86400  #データの間隔(秒)。1日 = 86400秒
market = "TYO"  #取引所のコード　TYO=東京証券取引所
period =  "1d" #データを取得する期間
min_price = 200
max_price = 1900
result = []

code_array.each do |code|
  url = base_url + "?q=#{code}&x=#{market}&i=#{interval}&p=#{period}&f=d,c,v,o,h,l&df=cpct&auto=1"
  open(url) do |f|
    f.each_line.with_index do |line, index|
      if index == 8
        end_price = line.split(',')[1].to_i
        if end_price >= min_price && end_price <= max_price
          result << [code, end_price]
        end
      end
    end
  end
end

CSV.open('225_end_price.csv','w') do |csv|
  result.each do |row|
    csv << row
  end
end
